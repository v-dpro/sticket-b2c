{"version":3,"file":"reactnativeerrorhandlers.js","sourceRoot":"","sources":["../../../src/js/integrations/reactnativeerrorhandlers.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EventHint, Integration, SeverityLevel } from '@sentry/core';\nimport {\n  addExceptionMechanism,\n  addGlobalUnhandledRejectionInstrumentationHandler,\n  captureException,\n  debug,\n  getClient,\n  getCurrentScope,\n} from '@sentry/core';\nimport type { ReactNativeClientOptions } from '../options';\nimport { isHermesEnabled, isWeb } from '../utils/environment';\nimport { createSyntheticError, isErrorLike } from '../utils/error';\nimport { RN_GLOBAL_OBJ } from '../utils/worldwide';\nimport { checkPromiseAndWarn, polyfillPromise, requireRejectionTracking } from './reactnativeerrorhandlersutils';\n\nconst INTEGRATION_NAME = 'ReactNativeErrorHandlers';\n\n/** ReactNativeErrorHandlers Options */\ninterface ReactNativeErrorHandlersOptions {\n  onerror: boolean;\n  onunhandledrejection: boolean;\n  patchGlobalPromise: boolean;\n}\n\ninterface PromiseRejectionTrackingOptions {\n  onUnhandled: (id: string, error: unknown) => void;\n  onHandled: (id: string) => void;\n}\n\n/** ReactNativeErrorHandlers Integration */\nexport const reactNativeErrorHandlersIntegration = (\n  options: Partial<ReactNativeErrorHandlersOptions> = {},\n): Integration => {\n  return {\n    name: INTEGRATION_NAME,\n    setupOnce: () =>\n      setup({\n        onerror: true,\n        onunhandledrejection: true,\n        patchGlobalPromise: true,\n        ...options,\n      }),\n  };\n};\n\nfunction setup(options: ReactNativeErrorHandlersOptions): void {\n  options.onunhandledrejection && setupUnhandledRejectionsTracking(options.patchGlobalPromise);\n  options.onerror && setupErrorUtilsGlobalHandler();\n}\n\n/**\n * Setup unhandled promise rejection tracking\n */\nfunction setupUnhandledRejectionsTracking(patchGlobalPromise: boolean): void {\n  try {\n    if (\n      isHermesEnabled() &&\n      RN_GLOBAL_OBJ.HermesInternal?.enablePromiseRejectionTracker &&\n      RN_GLOBAL_OBJ?.HermesInternal?.hasPromise?.()\n    ) {\n      debug.log('Using Hermes native promise rejection tracking');\n\n      RN_GLOBAL_OBJ.HermesInternal.enablePromiseRejectionTracker({\n        allRejections: true,\n        onUnhandled: promiseRejectionTrackingOptions.onUnhandled,\n        onHandled: promiseRejectionTrackingOptions.onHandled,\n      });\n\n      debug.log('Unhandled promise rejections will be caught by Sentry.');\n    } else if (isWeb()) {\n      debug.log('Using Browser JS promise rejection tracking for React Native Web');\n\n      // Use Sentry's built-in global unhandled rejection handler\n      addGlobalUnhandledRejectionInstrumentationHandler((error: unknown) => {\n        captureException(error, {\n          originalException: error,\n          syntheticException: isErrorLike(error) ? undefined : createSyntheticError(),\n          mechanism: { handled: false, type: 'onunhandledrejection' },\n        });\n      });\n    } else if (patchGlobalPromise) {\n      // For JSC and other environments, use the existing approach\n      polyfillPromise();\n      attachUnhandledRejectionHandler();\n      checkPromiseAndWarn();\n    } else {\n      // For JSC and other environments, patching was disabled by user configuration\n      debug.log('Unhandled promise rejections will not be caught by Sentry.');\n    }\n  } catch (e) {\n    debug.warn(\n      'Failed to set up promise rejection tracking. ' +\n        'Unhandled promise rejections will not be caught by Sentry.' +\n        'See https://docs.sentry.io/platforms/react-native/troubleshooting/ for more details.',\n    );\n  }\n}\n\nconst promiseRejectionTrackingOptions: PromiseRejectionTrackingOptions = {\n  onUnhandled: (id, error: unknown, rejection = {}) => {\n    if (__DEV__) {\n      debug.warn(`Possible Unhandled Promise Rejection (id: ${id}):\\n${rejection}`);\n    }\n\n    // Marking the rejection as handled to avoid breaking crash rate calculations.\n    // See: https://github.com/getsentry/sentry-react-native/issues/4141\n    captureException(error, {\n      data: { id },\n      originalException: error,\n      syntheticException: isErrorLike(error) ? undefined : createSyntheticError(),\n      mechanism: { handled: true, type: 'onunhandledrejection' },\n    });\n  },\n  onHandled: id => {\n    if (__DEV__) {\n      debug.warn(\n        `Promise Rejection Handled (id: ${id})\\n` +\n          'This means you can ignore any previous messages of the form ' +\n          `\"Possible Unhandled Promise Rejection (id: ${id}):\"`,\n      );\n    }\n  },\n};\n\nfunction attachUnhandledRejectionHandler(): void {\n  const tracking = requireRejectionTracking();\n\n  tracking.enable({\n    allRejections: true,\n    onUnhandled: promiseRejectionTrackingOptions.onUnhandled,\n    onHandled: promiseRejectionTrackingOptions.onHandled,\n  });\n}\n\nfunction setupErrorUtilsGlobalHandler(): void {\n  let handlingFatal = false;\n\n  const errorUtils = RN_GLOBAL_OBJ.ErrorUtils;\n  if (!errorUtils) {\n    debug.warn('ErrorUtils not found. Can be caused by different environment for example react-native-web.');\n    return;\n  }\n\n  const defaultHandler = errorUtils.getGlobalHandler?.();\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  errorUtils.setGlobalHandler(async (error: any, isFatal?: boolean) => {\n    // We want to handle fatals, but only in production mode.\n    const shouldHandleFatal = isFatal && !__DEV__;\n    if (shouldHandleFatal) {\n      if (handlingFatal) {\n        debug.log('Encountered multiple fatals in a row. The latest:', error);\n        return;\n      }\n      handlingFatal = true;\n    }\n\n    const client = getClient();\n\n    if (!client) {\n      debug.error('Sentry client is missing, the error event might be lost.', error);\n\n      // If there is no client something is fishy, anyway we call the default handler\n      defaultHandler(error, isFatal);\n\n      return;\n    }\n\n    const hint: EventHint = {\n      originalException: error,\n      attachments: getCurrentScope().getScopeData().attachments,\n    };\n    const event = await client.eventFromException(error, hint);\n\n    if (isFatal) {\n      event.level = 'fatal' as SeverityLevel;\n\n      addExceptionMechanism(event, {\n        handled: false,\n        type: 'onerror',\n      });\n    } else {\n      event.level = 'error';\n\n      addExceptionMechanism(event, {\n        handled: true,\n        type: 'generic',\n      });\n    }\n\n    client.captureEvent(event, hint);\n\n    if (__DEV__) {\n      // If in dev, we call the default handler anyway and hope the error will be sent\n      // Just for a better dev experience\n      defaultHandler(error, isFatal);\n      return;\n    }\n\n    void client.flush((client.getOptions() as ReactNativeClientOptions).shutdownTimeout || 2000).then(\n      () => {\n        defaultHandler(error, isFatal);\n      },\n      (reason: unknown) => {\n        debug.error('[ReactNativeErrorHandlers] Error while flushing the event cache after uncaught error.', reason);\n      },\n    );\n  });\n}\n"]}