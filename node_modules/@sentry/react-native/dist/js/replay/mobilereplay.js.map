{"version":3,"file":"mobilereplay.js","sourceRoot":"","sources":["../../../src/js/replay/mobilereplay.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Client, DynamicSamplingContext, Event, EventHint, Integration } from '@sentry/core';\nimport { debug } from '@sentry/core';\nimport { isHardCrash } from '../misc';\nimport { hasHooks } from '../utils/clientutils';\nimport { isExpoGo, notMobileOs } from '../utils/environment';\nimport { NATIVE } from '../wrapper';\nimport { enrichXhrBreadcrumbsForMobileReplay } from './xhrUtils';\n\nexport const MOBILE_REPLAY_INTEGRATION_NAME = 'MobileReplay';\n\n/**\n * Screenshot strategy type for Android Session Replay.\n *\n * - `'canvas'`: Canvas-based screenshot strategy. This strategy does **not** support any masking options, it always masks text and images. Use this if your application has strict PII requirements.\n * - `'pixelCopy'`: Pixel copy screenshot strategy (default). Supports all masking options.\n */\nexport type ScreenshotStrategy = 'canvas' | 'pixelCopy';\n\nexport interface MobileReplayOptions {\n  /**\n   * Mask all text in recordings\n   *\n   * @default true\n   */\n  maskAllText?: boolean;\n\n  /**\n   * Mask all images in recordings\n   *\n   * @default true\n   */\n  maskAllImages?: boolean;\n\n  /**\n   * Mask all vector graphics in recordings\n   * Supports `react-native-svg`\n   *\n   * @default true\n   */\n  maskAllVectors?: boolean;\n\n  /**\n   * Enables the up to 5x faster experimental view renderer used by the Session Replay integration on iOS.\n   *\n   * Enabling this flag will reduce the amount of time it takes to render each frame of the session replay on the main thread, therefore reducing\n   * interruptions and visual lag.\n   *\n   * - Experiment: This is an experimental feature and is therefore disabled by default.\n   *\n   * @deprecated Use `enableViewRendererV2` instead.\n   * @platform ios\n   */\n  enableExperimentalViewRenderer?: boolean;\n\n  /**\n   * Enables up to 5x faster new view renderer used by the Session Replay integration on iOS.\n   *\n   * Enabling this flag will reduce the amount of time it takes to render each frame of the session replay on the main thread, therefore reducing\n   * interruptions and visual lag. [Our benchmarks](https://github.com/getsentry/sentry-cocoa/pull/4940) have shown a significant improvement of\n   * **up to 4-5x faster rendering** (reducing `~160ms` to `~36ms` per frame) on older devices.\n   *\n   * - Experiment: In case you are noticing issues with the new view renderer, please report the issue on [GitHub](https://github.com/getsentry/sentry-cocoa).\n   *               Eventually, we will remove this feature flag and use the new view renderer by default.\n   *\n   * @default true\n   * @platform ios\n   */\n  enableViewRendererV2?: boolean;\n\n  /**\n   * Enables up to 5x faster but incomplete view rendering used by the Session Replay integration on iOS.\n   *\n   * Enabling this flag will reduce the amount of time it takes to render each frame of the session replay on the main thread, therefore reducing\n   * interruptions and visual lag.\n   *\n   * - Note: This flag can only be used together with `enableExperimentalViewRenderer` with up to 20% faster render times.\n   * - Experiment: This is an experimental feature and is therefore disabled by default.\n   *\n   * @default false\n   * @platform ios\n   */\n  enableFastViewRendering?: boolean;\n\n  /**\n   * Sets the screenshot strategy used by the Session Replay integration on Android.\n   *\n   * If your application has strict PII requirements we recommend using `'canvas'`.\n   * This strategy does **not** support any masking options, it always masks text and images.\n   *\n   * - Experiment: In case you are noticing issues with the canvas screenshot strategy, please report the issue on [GitHub](https://github.com/getsentry/sentry-java).\n   *\n   * @default 'pixelCopy'\n   * @platform android\n   */\n  screenshotStrategy?: ScreenshotStrategy;\n\n  /**\n   * Callback to determine if a replay should be captured for a specific error.\n   * When this callback returns `false`, no replay will be captured for the error.\n   * This callback is only called when an error occurs and `replaysOnErrorSampleRate` is set.\n   *\n   * @param event The error event\n   * @param hint Additional event information\n   * @returns `false` to skip capturing a replay for this error, `true` or `undefined` to proceed with sampling\n   */\n  beforeErrorSampling?: (event: Event, hint: EventHint) => boolean;\n}\n\nconst defaultOptions: MobileReplayOptions = {\n  maskAllText: true,\n  maskAllImages: true,\n  maskAllVectors: true,\n  enableExperimentalViewRenderer: false,\n  enableViewRendererV2: true,\n  enableFastViewRendering: false,\n  screenshotStrategy: 'pixelCopy',\n};\n\nfunction mergeOptions(initOptions: Partial<MobileReplayOptions>): MobileReplayOptions {\n  const merged = {\n    ...defaultOptions,\n    ...initOptions,\n  };\n\n  if (initOptions.enableViewRendererV2 === undefined && initOptions.enableExperimentalViewRenderer !== undefined) {\n    merged.enableViewRendererV2 = initOptions.enableExperimentalViewRenderer;\n  }\n\n  return merged;\n}\n\ntype MobileReplayIntegration = Integration & {\n  options: MobileReplayOptions;\n  getReplayId: () => string | null;\n};\n\n/**\n * The Mobile Replay Integration, let's you adjust the default mobile replay options.\n * To be passed to `Sentry.init` with `replaysOnErrorSampleRate` or `replaysSessionSampleRate`.\n *\n * ```javascript\n * Sentry.init({\n *  replaysOnErrorSampleRate: 1.0,\n *  replaysSessionSampleRate: 1.0,\n *  integrations: [mobileReplayIntegration({\n *    // Adjust the default options\n *  })],\n * });\n * ```\n *\n * @experimental\n */\nexport const mobileReplayIntegration = (initOptions: MobileReplayOptions = defaultOptions): MobileReplayIntegration => {\n  if (isExpoGo()) {\n    debug.warn(\n      `[Sentry] ${MOBILE_REPLAY_INTEGRATION_NAME} is not supported in Expo Go. Use EAS Build or \\`expo prebuild\\` to enable it.`,\n    );\n  }\n  if (notMobileOs()) {\n    debug.warn(`[Sentry] ${MOBILE_REPLAY_INTEGRATION_NAME} is not supported on this platform.`);\n  }\n\n  if (isExpoGo() || notMobileOs()) {\n    return mobileReplayIntegrationNoop();\n  }\n\n  const options = mergeOptions(initOptions);\n\n  // Cache the replay ID in JavaScript to avoid excessive bridge calls\n  // This will be updated when we know the replay ID changes (e.g., after captureReplay)\n  let cachedReplayId: string | null = null;\n\n  function updateCachedReplayId(replayId: string | null): void {\n    cachedReplayId = replayId;\n  }\n\n  function getCachedReplayId(): string | null {\n    if (cachedReplayId !== null) {\n      return cachedReplayId;\n    }\n    const nativeReplayId = NATIVE.getCurrentReplayId();\n    if (nativeReplayId) {\n      cachedReplayId = nativeReplayId;\n    }\n    return nativeReplayId;\n  }\n\n  async function processEvent(event: Event, hint: EventHint): Promise<Event> {\n    const hasException = event.exception?.values && event.exception.values.length > 0;\n    if (!hasException) {\n      // Event is not an error, will not capture replay\n      return event;\n    }\n\n    // Check if beforeErrorSampling callback filters out this error\n    if (initOptions.beforeErrorSampling) {\n      try {\n        if (initOptions.beforeErrorSampling(event, hint) === false) {\n          debug.log(\n            `[Sentry] ${MOBILE_REPLAY_INTEGRATION_NAME} not sent; beforeErrorSampling conditions not met for event ${event.event_id}.`,\n          );\n          return event;\n        }\n      } catch (error) {\n        debug.error(\n          `[Sentry] ${MOBILE_REPLAY_INTEGRATION_NAME} beforeErrorSampling callback threw an error, proceeding with replay capture`,\n          error,\n        );\n        // Continue with replay capture if callback throws\n      }\n    }\n\n    const replayId = await NATIVE.captureReplay(isHardCrash(event));\n    if (replayId) {\n      updateCachedReplayId(replayId);\n      debug.log(\n        `[Sentry] ${MOBILE_REPLAY_INTEGRATION_NAME} Captured recording replay ${replayId} for event ${event.event_id}.`,\n      );\n    } else {\n      // Check if there's an ongoing recording and update cache if found\n      const recordingReplayId = NATIVE.getCurrentReplayId();\n      if (recordingReplayId) {\n        updateCachedReplayId(recordingReplayId);\n        debug.log(\n          `[Sentry] ${MOBILE_REPLAY_INTEGRATION_NAME} assign already recording replay ${recordingReplayId} for event ${event.event_id}.`,\n        );\n      } else {\n        updateCachedReplayId(null);\n        debug.log(`[Sentry] ${MOBILE_REPLAY_INTEGRATION_NAME} not sampled for event ${event.event_id}.`);\n      }\n    }\n\n    return event;\n  }\n\n  function setup(client: Client): void {\n    if (!hasHooks(client)) {\n      return;\n    }\n\n    // Initialize the cached replay ID on setup\n    cachedReplayId = NATIVE.getCurrentReplayId();\n\n    client.on('createDsc', (dsc: DynamicSamplingContext) => {\n      if (dsc.replay_id) {\n        return;\n      }\n\n      // Use cached replay ID to avoid bridge calls\n      const currentReplayId = getCachedReplayId();\n      if (currentReplayId) {\n        dsc.replay_id = currentReplayId;\n      }\n    });\n\n    client.on('beforeAddBreadcrumb', enrichXhrBreadcrumbsForMobileReplay);\n  }\n\n  function getReplayId(): string | null {\n    return getCachedReplayId();\n  }\n\n  // TODO: When adding manual API, ensure overlap with the web replay so users can use the same API interchangeably\n  // https://github.com/getsentry/sentry-javascript/blob/develop/packages/replay-internal/src/integration.ts#L45\n  return {\n    name: MOBILE_REPLAY_INTEGRATION_NAME,\n    setup,\n    processEvent,\n    options: options,\n    getReplayId: getReplayId,\n  };\n};\n\nconst mobileReplayIntegrationNoop = (): MobileReplayIntegration => {\n  return {\n    name: MOBILE_REPLAY_INTEGRATION_NAME,\n    options: defaultOptions,\n    getReplayId: () => null, // Mock implementation for noop version\n  };\n};\n"]}