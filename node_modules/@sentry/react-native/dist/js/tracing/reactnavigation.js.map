{"version":3,"file":"reactnavigation.js","sourceRoot":"","sources":["../../../src/js/tracing/reactnavigation.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable max-lines */\nimport type { Client, Integration, Span } from '@sentry/core';\nimport {\n  addBreadcrumb,\n  debug,\n  getClient,\n  isPlainObject,\n  SEMANTIC_ATTRIBUTE_SENTRY_OP,\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  SPAN_STATUS_OK,\n  spanToJSON,\n  startInactiveSpan,\n  timestampInSeconds,\n} from '@sentry/core';\nimport { getAppRegistryIntegration } from '../integrations/appRegistry';\nimport { isSentrySpan } from '../utils/span';\nimport { RN_GLOBAL_OBJ } from '../utils/worldwide';\nimport type { UnsafeAction } from '../vendor/react-navigation/types';\nimport { NATIVE } from '../wrapper';\nimport { ignoreEmptyBackNavigation, ignoreEmptyRouteChangeTransactions } from './onSpanEndUtils';\nimport { SPAN_ORIGIN_AUTO_NAVIGATION_REACT_NAVIGATION } from './origin';\nimport type { ReactNativeTracingIntegration } from './reactnativetracing';\nimport { getReactNativeTracingIntegration } from './reactnativetracing';\nimport { SEMANTIC_ATTRIBUTE_NAVIGATION_ACTION_TYPE, SEMANTIC_ATTRIBUTE_SENTRY_SOURCE } from './semanticAttributes';\nimport {\n  DEFAULT_NAVIGATION_SPAN_NAME,\n  defaultIdleOptions,\n  getDefaultIdleNavigationSpanOptions,\n  startIdleNavigationSpan as startGenericIdleNavigationSpan,\n} from './span';\nimport { addTimeToInitialDisplayFallback } from './timeToDisplayFallback';\n\nexport const INTEGRATION_NAME = 'ReactNavigation';\n\nconst NAVIGATION_HISTORY_MAX_SIZE = 200;\n\n/**\n * Builds a full path from the navigation state by traversing nested navigators.\n * For example, with nested navigators: \"Home/Settings/Profile\"\n */\nfunction getPathFromState(state?: NavigationState): string | undefined {\n  if (!state) {\n    return undefined;\n  }\n\n  const routeNames: string[] = [];\n  let currentState: NavigationState | undefined = state;\n\n  while (currentState) {\n    const index: number = currentState.index ?? 0;\n    const route: NavigationRoute | undefined = currentState.routes[index];\n    if (route?.name) {\n      routeNames.push(route.name);\n    }\n    currentState = route?.state;\n  }\n\n  return routeNames.length > 0 ? routeNames.join('/') : undefined;\n}\n\ninterface ReactNavigationIntegrationOptions {\n  /**\n   * How long the instrumentation will wait for the route to mount after a change has been initiated,\n   * before the transaction is discarded.\n   *\n   * @default 1_000 (ms)\n   */\n  routeChangeTimeoutMs: number;\n\n  /**\n   * Time to initial display measures the time it takes from\n   * navigation dispatch to the render of the first frame of the new screen.\n   *\n   * @default false\n   */\n  enableTimeToInitialDisplay: boolean;\n\n  /**\n   * Does not sample transactions that are from routes that have been seen any more and don't have any spans.\n   * This removes a lot of the clutter as most back navigation transactions are now ignored.\n   *\n   * @default true\n   */\n  ignoreEmptyBackNavigationTransactions: boolean;\n\n  /**\n   * Enabled measuring Time to Initial Display for routes that are already loaded in memory.\n   * (a.k.a., Routes that the navigation integration has already seen.)\n   *\n   * @default false\n   */\n  enableTimeToInitialDisplayForPreloadedRoutes: boolean;\n\n  /**\n   * Whether to use the dispatched action data to populate the transaction metadata.\n   *\n   * @default false\n   */\n  useDispatchedActionData: boolean;\n\n  /**\n   * Whether to use the full paths for navigation routes.\n   *\n   * @default false\n   */\n  useFullPathsForNavigationRoutes: boolean;\n}\n\n/**\n * Instrumentation for React-Navigation V5 and above. See docs or sample app for usage.\n *\n * How this works:\n * - `_onDispatch` is called every time a dispatch happens and sets an IdleTransaction on the scope without any route context.\n * - `_onStateChange` is then called AFTER the state change happens due to a dispatch and sets the route context onto the active transaction.\n * - If `_onStateChange` isn't called within `STATE_CHANGE_TIMEOUT_DURATION` of the dispatch, then the transaction is not sampled and finished.\n */\nexport const reactNavigationIntegration = ({\n  routeChangeTimeoutMs = 1_000,\n  enableTimeToInitialDisplay = false,\n  ignoreEmptyBackNavigationTransactions = true,\n  enableTimeToInitialDisplayForPreloadedRoutes = false,\n  useDispatchedActionData = false,\n  useFullPathsForNavigationRoutes = false,\n}: Partial<ReactNavigationIntegrationOptions> = {}): Integration & {\n  /**\n   * Pass the ref to the navigation container to register it to the instrumentation\n   * @param navigationContainerRef Ref to a `NavigationContainer`\n   */\n  registerNavigationContainer: (navigationContainerRef: unknown) => void;\n  options: ReactNavigationIntegrationOptions;\n} => {\n  let navigationContainer: NavigationContainer | undefined;\n\n  let tracing: ReactNativeTracingIntegration | undefined;\n  let idleSpanOptions: Parameters<typeof startGenericIdleNavigationSpan>[1] = defaultIdleOptions;\n  let latestRoute: NavigationRoute | undefined;\n\n  let latestNavigationSpan: Span | undefined;\n  let navigationProcessingSpan: Span | undefined;\n\n  let initialStateHandled: boolean = false;\n  let stateChangeTimeout: ReturnType<typeof setTimeout> | undefined;\n  let recentRouteKeys: string[] = [];\n\n  if (enableTimeToInitialDisplay) {\n    NATIVE.initNativeReactNavigationNewFrameTracking().catch((reason: unknown) => {\n      debug.error(`${INTEGRATION_NAME} Failed to initialize native new frame tracking: ${reason}`);\n    });\n  }\n\n  /**\n   * Set the initial state and start initial navigation span for the current screen.\n   */\n  const afterAllSetup = (client: Client): void => {\n    tracing = getReactNativeTracingIntegration(client);\n    if (tracing) {\n      idleSpanOptions = {\n        finalTimeout: tracing.options.finalTimeoutMs,\n        idleTimeout: tracing.options.idleTimeoutMs,\n      };\n    }\n\n    if (initialStateHandled) {\n      // We create an initial state here to ensure a transaction gets created before the first route mounts.\n      // This assumes that the Sentry.init() call is made before the first route mounts.\n      // If this is not the case, the first transaction will be nameless 'Route Changed'\n      return undefined;\n    }\n\n    getAppRegistryIntegration(client)?.onRunApplication(() => {\n      if (initialStateHandled) {\n        // To avoid conflict with the initial transaction we check if it was already handled.\n        // This ensures runApplication calls after the initial start are correctly traced.\n        // This is used for example when Activity is (re)started on Android.\n        debug.log('[ReactNavigationIntegration] Starting new idle navigation span based on runApplication call.');\n        startIdleNavigationSpan(undefined, true);\n      }\n    });\n\n    startIdleNavigationSpan();\n\n    if (!navigationContainer) {\n      // This is expected as navigation container is registered after the root component is mounted.\n      return undefined;\n    }\n\n    // Navigation container already registered, just populate with route state\n    updateLatestNavigationSpanWithCurrentRoute();\n    initialStateHandled = true;\n  };\n\n  const registerNavigationContainer = (maybeNewNavigationContainer: unknown): void => {\n    if (RN_GLOBAL_OBJ.__sentry_rn_v5_registered) {\n      debug.log(`${INTEGRATION_NAME} Instrumentation already exists, but registering again...`);\n      // In the past we have not allowed re-registering the navigation container to avoid unexpected behavior.\n      // But this doesn't work for Android and re-recreating application main activity.\n      // Where new navigation container is created and the old one is discarded. We need to re-register to\n      // trace the new navigation container navigation.\n    }\n\n    let newNavigationContainer: NavigationContainer | undefined;\n    if (isPlainObject(maybeNewNavigationContainer) && 'current' in maybeNewNavigationContainer) {\n      newNavigationContainer = maybeNewNavigationContainer.current as NavigationContainer;\n    } else {\n      newNavigationContainer = maybeNewNavigationContainer as NavigationContainer;\n    }\n\n    if (navigationContainer === newNavigationContainer) {\n      debug.log(`${INTEGRATION_NAME} Navigation container ref is the same as the one already registered.`);\n      return;\n    }\n    navigationContainer = newNavigationContainer;\n\n    if (!navigationContainer) {\n      debug.warn(`${INTEGRATION_NAME} Received invalid navigation container ref!`);\n      return undefined;\n    }\n\n    // This action is emitted on every dispatch\n    navigationContainer.addListener('__unsafe_action__', startIdleNavigationSpan);\n    navigationContainer.addListener('state', updateLatestNavigationSpanWithCurrentRoute);\n    RN_GLOBAL_OBJ.__sentry_rn_v5_registered = true;\n\n    if (initialStateHandled) {\n      return undefined;\n    }\n\n    if (!latestNavigationSpan) {\n      debug.log(`${INTEGRATION_NAME} Navigation container registered, but integration has not been setup yet.`);\n      return undefined;\n    }\n\n    // Navigation Container is registered after the first navigation\n    // Initial navigation span was started, after integration setup,\n    // so now we populate it with the current route.\n    updateLatestNavigationSpanWithCurrentRoute();\n    initialStateHandled = true;\n  };\n\n  /**\n   * To be called on every React-Navigation action dispatch.\n   * It does not name the transaction or populate it with route information. Instead, it waits for the state to fully change\n   * and gets the route information from there, @see updateLatestNavigationSpanWithCurrentRoute\n   *\n   * @param unknownEvent - The event object that contains navigation action data\n   * @param isAppRestart - Whether this span is being started due to an app restart rather than a normal navigation action\n   */\n  const startIdleNavigationSpan = (unknownEvent?: unknown, isAppRestart = false): void => {\n    const event = unknownEvent as UnsafeAction | undefined;\n    if (useDispatchedActionData && event?.data.noop) {\n      debug.log(`${INTEGRATION_NAME} Navigation action is a noop, not starting navigation span.`);\n      return;\n    }\n\n    const navigationActionType = useDispatchedActionData ? event?.data.action.type : undefined;\n    if (\n      useDispatchedActionData &&\n      navigationActionType &&\n      [\n        // Process common actions\n        'PRELOAD',\n        'SET_PARAMS',\n        // Drawer actions\n        'OPEN_DRAWER',\n        'CLOSE_DRAWER',\n        'TOGGLE_DRAWER',\n      ].includes(navigationActionType)\n    ) {\n      debug.log(`${INTEGRATION_NAME} Navigation action is ${navigationActionType}, not starting navigation span.`);\n      return;\n    }\n\n    if (latestNavigationSpan) {\n      debug.log(`${INTEGRATION_NAME} A transaction was detected that turned out to be a noop, discarding.`);\n      _discardLatestTransaction();\n      clearStateChangeTimeout();\n    }\n\n    latestNavigationSpan = startGenericIdleNavigationSpan(\n      tracing?.options.beforeStartSpan\n        ? tracing.options.beforeStartSpan(getDefaultIdleNavigationSpanOptions())\n        : getDefaultIdleNavigationSpanOptions(),\n      { ...idleSpanOptions, isAppRestart },\n    );\n    latestNavigationSpan?.setAttribute(SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN, SPAN_ORIGIN_AUTO_NAVIGATION_REACT_NAVIGATION);\n    latestNavigationSpan?.setAttribute(SEMANTIC_ATTRIBUTE_NAVIGATION_ACTION_TYPE, navigationActionType);\n    if (ignoreEmptyBackNavigationTransactions) {\n      ignoreEmptyBackNavigation(getClient(), latestNavigationSpan);\n    }\n    // Always discard transactions that never receive route information\n    const spanToCheck = latestNavigationSpan;\n    ignoreEmptyRouteChangeTransactions(\n      getClient(),\n      spanToCheck,\n      DEFAULT_NAVIGATION_SPAN_NAME,\n      () => latestNavigationSpan === spanToCheck,\n    );\n\n    if (enableTimeToInitialDisplay && latestNavigationSpan) {\n      NATIVE.setActiveSpanId(latestNavigationSpan.spanContext().spanId);\n      navigationProcessingSpan = startInactiveSpan({\n        op: 'navigation.processing',\n        name: 'Navigation dispatch to navigation cancelled or screen mounted',\n        startTime: spanToJSON(latestNavigationSpan).start_timestamp,\n      });\n      navigationProcessingSpan.setAttribute(\n        SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n        SPAN_ORIGIN_AUTO_NAVIGATION_REACT_NAVIGATION,\n      );\n    }\n\n    stateChangeTimeout = setTimeout(_discardLatestTransaction, routeChangeTimeoutMs);\n  };\n\n  /**\n   * To be called AFTER the state has been changed to populate the transaction with the current route.\n   */\n  const updateLatestNavigationSpanWithCurrentRoute = (): void => {\n    const stateChangedTimestamp = timestampInSeconds();\n    const previousRoute = latestRoute;\n\n    if (!navigationContainer) {\n      debug.warn(`${INTEGRATION_NAME} Missing navigation container ref. Route transactions will not be sent.`);\n      return undefined;\n    }\n\n    const route = navigationContainer.getCurrentRoute();\n    if (!route) {\n      debug.log(`[${INTEGRATION_NAME}] Navigation state changed, but no route is rendered.`);\n      return undefined;\n    }\n\n    if (!latestNavigationSpan) {\n      debug.log(\n        `[${INTEGRATION_NAME}] Navigation state changed, but navigation transaction was not started on dispatch.`,\n      );\n      return undefined;\n    }\n\n    addTimeToInitialDisplayFallback(latestNavigationSpan.spanContext().spanId, NATIVE.getNewScreenTimeToDisplay());\n\n    if (previousRoute && previousRoute.key === route.key) {\n      debug.log(`[${INTEGRATION_NAME}] Navigation state changed, but route is the same as previous.`);\n      pushRecentRouteKey(route.key);\n      latestRoute = route;\n\n      // Clear the latest transaction as it has been handled.\n      latestNavigationSpan = undefined;\n      return undefined;\n    }\n\n    const routeHasBeenSeen = recentRouteKeys.includes(route.key);\n\n    // Get the full navigation path for nested navigators\n    let routeName = route.name;\n    if (useFullPathsForNavigationRoutes) {\n      const navigationState = navigationContainer.getState();\n      routeName = getPathFromState(navigationState) || route.name;\n    }\n\n    navigationProcessingSpan?.updateName(`Navigation dispatch to screen ${routeName} mounted`);\n    navigationProcessingSpan?.setStatus({ code: SPAN_STATUS_OK });\n    navigationProcessingSpan?.end(stateChangedTimestamp);\n    navigationProcessingSpan = undefined;\n\n    if (spanToJSON(latestNavigationSpan).description === DEFAULT_NAVIGATION_SPAN_NAME) {\n      latestNavigationSpan.updateName(routeName);\n    }\n    latestNavigationSpan.setAttributes({\n      'route.name': routeName,\n      'route.key': route.key,\n      // TODO: filter PII params instead of dropping them all\n      // 'route.params': {},\n      'route.has_been_seen': routeHasBeenSeen,\n      'previous_route.name': previousRoute?.name,\n      'previous_route.key': previousRoute?.key,\n      // TODO: filter PII params instead of dropping them all\n      // 'previous_route.params': {},\n      [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: 'component',\n      [SEMANTIC_ATTRIBUTE_SENTRY_OP]: 'navigation',\n    });\n\n    // Clear the timeout so the transaction does not get cancelled.\n    clearStateChangeTimeout();\n\n    addBreadcrumb({\n      category: 'navigation',\n      type: 'navigation',\n      message: `Navigation to ${routeName}`,\n      data: {\n        from: previousRoute?.name,\n        to: routeName,\n      },\n    });\n\n    tracing?.setCurrentRoute(routeName);\n\n    pushRecentRouteKey(route.key);\n    if (useFullPathsForNavigationRoutes) {\n      latestRoute = { ...route, name: routeName };\n    } else {\n      latestRoute = route;\n    }\n    // Clear the latest transaction as it has been handled.\n    latestNavigationSpan = undefined;\n  };\n\n  /** Pushes a recent route key, and removes earlier routes when there is greater than the max length */\n  const pushRecentRouteKey = (key: string): void => {\n    recentRouteKeys.push(key);\n\n    if (recentRouteKeys.length > NAVIGATION_HISTORY_MAX_SIZE) {\n      recentRouteKeys = recentRouteKeys.slice(recentRouteKeys.length - NAVIGATION_HISTORY_MAX_SIZE);\n    }\n  };\n\n  /** Cancels the latest transaction so it does not get sent to Sentry. */\n  const _discardLatestTransaction = (): void => {\n    if (latestNavigationSpan) {\n      if (isSentrySpan(latestNavigationSpan)) {\n        latestNavigationSpan['_sampled'] = false;\n      }\n      // TODO: What if it's not SentrySpan?\n      latestNavigationSpan.end();\n      latestNavigationSpan = undefined;\n    }\n    if (navigationProcessingSpan) {\n      navigationProcessingSpan = undefined;\n    }\n  };\n\n  const clearStateChangeTimeout = (): void => {\n    if (typeof stateChangeTimeout !== 'undefined') {\n      clearTimeout(stateChangeTimeout);\n      stateChangeTimeout = undefined;\n    }\n  };\n\n  return {\n    name: INTEGRATION_NAME,\n    afterAllSetup,\n    registerNavigationContainer,\n    options: {\n      routeChangeTimeoutMs,\n      enableTimeToInitialDisplay,\n      ignoreEmptyBackNavigationTransactions,\n      enableTimeToInitialDisplayForPreloadedRoutes,\n      useDispatchedActionData,\n      useFullPathsForNavigationRoutes,\n    },\n  };\n};\n\nexport interface NavigationRoute {\n  name: string;\n  key: string;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  params?: Record<string, any>;\n  state?: NavigationState;\n}\n\ninterface NavigationState {\n  index?: number;\n  routes: NavigationRoute[];\n}\n\ninterface NavigationContainer {\n  addListener: (type: string, listener: (event?: unknown) => void) => void;\n  getCurrentRoute: () => NavigationRoute;\n  getState: () => NavigationState | undefined;\n}\n\n/**\n * Returns React Navigation integration of the given client.\n */\nexport function getReactNavigationIntegration(\n  client: Client,\n): ReturnType<typeof reactNavigationIntegration> | undefined {\n  return client.getIntegrationByName<ReturnType<typeof reactNavigationIntegration>>(INTEGRATION_NAME);\n}\n"]}