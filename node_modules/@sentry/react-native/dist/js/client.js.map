{"version":3,"file":"client.js","sourceRoot":"","sources":["../../src/js/client.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,kBAAkB,EAAE,gBAAgB,EAAE,MAAM,iBAAiB,CAAC;AAYvE,OAAO,EACL,yBAAyB,EACzB,yBAAyB,EACzB,MAAM,EACN,sBAAsB,EACtB,KAAK,EACL,WAAW,GACZ,MAAM,cAAc,CAAC;AACtB,OAAO,EAAE,KAAK,EAAE,MAAM,cAAc,CAAC;AACrC,OAAO,EAAE,YAAY,EAAE,MAAM,uCAAuC,CAAC;AACrE,OAAO,EAAE,cAAc,EAAE,MAAM,wBAAwB,CAAC;AACxD,OAAO,EAAE,oBAAoB,EAAE,MAAM,0BAA0B,CAAC;AAGhE,OAAO,EAAE,8BAA8B,EAAE,MAAM,uBAAuB,CAAC;AACvE,OAAO,EAAE,0BAA0B,EAAE,KAAK,EAAE,MAAM,kBAAkB,CAAC;AACrE,OAAO,EAAE,sBAAsB,EAAE,MAAM,gCAAgC,CAAC;AACxE,OAAO,EAAE,aAAa,EAAE,MAAM,iBAAiB,CAAC;AAChD,OAAO,EAAE,oBAAoB,EAAE,MAAM,qBAAqB,CAAC;AAC3D,OAAO,EAAE,MAAM,EAAE,MAAM,WAAW,CAAC;AAEnC,MAAM,sBAAsB,GAAG,IAAI,CAAC;AAEpC;;;;;GAKG;AACH,MAAM,OAAO,iBAAkB,SAAQ,MAAgC;IAIrE;;;OAGG;IACH,YAAmB,OAAiC;;QAClD,sBAAsB,CAAC,MAAA,oBAAoB,CAAC,kBAAkB,0CAAE,OAAO,CAAC,CAAC;QACzE,OAAO,CAAC,SAAS,mCACZ,OAAO,CAAC,SAAS,KACpB,GAAG,kCACE,CAAC,CAAA,MAAA,OAAO,CAAC,SAAS,0CAAE,GAAG,KAAI,cAAc,CAAC,KAC7C,QAAQ;oBACN,4DAA4D;oBAC5D,QAAQ,EAAE,OAAO,CAAC,cAAc,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,OAAO,IAChD,MAAA,MAAA,OAAO,CAAC,SAAS,0CAAE,GAAG,0CAAE,QAAQ,OAGxC,CAAC;QAEF,uDAAuD;QACvD,OAAO,CAAC,0BAA0B;YAChC,OAAO,CAAC,0BAA0B,KAAK,SAAS,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,OAAO,CAAC,0BAA0B,CAAC;QAE/F,mFAAmF;QACnF,iGAAiG;QACjG,MAAM,kBAAkB,GAAG,OAAO,CAAC,UAAU,CAAC;QAC9C,IAAI,OAAO,CAAC,UAAU,IAAI,OAAO,CAAC,UAAU,KAAK,QAAQ,EAAE;YACzD,KAAK,CAAC,GAAG,CAAC,mEAAmE,CAAC,CAAC;YAC/E,OAAO,CAAC,UAAU,GAAG,KAAK,CAAC;SAC5B;QAED,KAAK,CAAC,OAAO,CAAC,CAAC;QAEf,IAAI,CAAC,eAAe,GAAG,EAAE,CAAC;QAE1B,IAAI,OAAO,CAAC,cAAc,KAAK,IAAI,EAAE;YACnC,IAAI,CAAC,EAAE,CAAC,mBAAmB,EAAE,yBAAyB,CAAC,CAAC;SACzD;QAED,IAAI,OAAO,CAAC,UAAU,EAAE;YACtB,IAAI,CAAC,EAAE,CAAC,OAAO,EAAE,GAAG,EAAE;gBACpB,yBAAyB,CAAC,IAAI,CAAC,CAAC;YAClC,CAAC,CAAC,CAAC;YAEH,IAAI,CAAC,EAAE,CAAC,iBAAiB,EAAE,GAAG,EAAE;gBAC9B,IAAI,IAAI,CAAC,oBAAoB,EAAE;oBAC7B,YAAY,CAAC,IAAI,CAAC,oBAAoB,CAAC,CAAC;iBACzC;gBAED,IAAI,CAAC,oBAAoB,GAAG,UAAU,CAAC,GAAG,EAAE;oBAC1C,yBAAyB,CAAC,IAAI,CAAC,CAAC;gBAClC,CAAC,EAAE,sBAAsB,CAAC,CAAC;YAC7B,CAAC,CAAC,CAAC;SACJ;QAED,yDAAyD;QACzD,OAAO,CAAC,UAAU,GAAG,kBAAkB,CAAC;IAC1C,CAAC;IAED;;OAEG;IACI,kBAAkB,CAAC,SAAkB,EAAE,OAAkB,EAAE;QAChE,OAAO,kBAAkB,CAAC,IAAI,CAAC,QAAQ,CAAC,WAAW,EAAE,SAAS,EAAE,IAAI,EAAE,IAAI,CAAC,QAAQ,CAAC,gBAAgB,CAAC,CAAC;IACxG,CAAC;IAED;;OAEG;IACI,gBAAgB,CAAC,OAAe,EAAE,KAAqB,EAAE,IAAgB;QAC9E,OAAO,gBAAgB,CAAC,IAAI,CAAC,QAAQ,CAAC,WAAW,EAAE,OAAO,EAAE,KAAK,EAAE,IAAI,EAAE,IAAI,CAAC,QAAQ,CAAC,gBAAgB,CAAC,CAAC;IAC3G,CAAC;IAED;;;OAGG;IACI,WAAW;QAChB,MAAM,CAAC,WAAW,EAAE,CAAC;IACvB,CAAC;IAED;;OAEG;IACI,KAAK;QACV,oGAAoG;QACpG,OAAO,KAAK,CAAC,KAAK,EAAE,CAAC,IAAI,CAAC,CAAC,MAAe,EAAE,EAAE;YAC5C,OAAO,MAAM,CAAC,cAAc,EAAE,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC,MAAM,CAAC,CAAC;QACpD,CAAC,CAAC,CAAC;IACL,CAAC;IAED;;;OAGG;IACI,mBAAmB,CAAC,QAAsB;QAC/C,MAAM,QAAQ,GAAG,0BAA0B,CAAC,QAAQ,EAAE;YACpD,QAAQ,EAAE,IAAI,CAAC,QAAQ,CAAC,SAAS;YACjC,GAAG,EAAE,IAAI,CAAC,MAAM,EAAE;YAClB,MAAM,EAAE,SAAS;SAClB,CAAC,CAAC;QACH,mEAAmE;QACnE,IAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,CAAC;IAC9B,CAAC;IAED;;OAEG;IACI,YAAY,CAAC,QAAkB;QACpC,MAAM,QAAQ,GAAG,IAAI,CAAC,cAAc,EAAE,CAAC;QACvC,IAAI,CAAC,eAAe,GAAG,aAAa,CAAC,IAAI,CAAC,eAAe,EAAE,QAAQ,CAAC,CAAC;QAErE,IAAI,IAAI,CAAC,QAAQ,CAAC,iBAAiB,EAAE;YACnC,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,eAAe,EAAE,QAAgC,CAAC,CAAC;SACpF;QAED,IAAI,yBAAyB,GAAG,IAAI,CAAC;QACrC,IAAI,IAAI,CAAC,UAAU,EAAE,IAAI,IAAI,CAAC,UAAU,IAAI,IAAI,CAAC,IAAI,EAAE;YACrD,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,QAAQ,CAAC,CAAC;YAEtC,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,IAAI,EAAE,MAAM,CAAC,EAAE;gBACjD,IAAI,MAAM,YAAY,WAAW,EAAE;oBACjC,uCAAuC;oBACvC,yBAAyB,GAAG,KAAK,CAAC;oBAClC,6EAA6E;oBAC7E,KAAK,CAAC,KAAK,CAAC,2DAA2D,EAAE,MAAM,CAAC,CAAC;iBAClF;qBAAM;oBACL,KAAK,CAAC,KAAK,CAAC,4BAA4B,EAAE,MAAM,CAAC,CAAC;iBACnD;YACH,CAAC,CAAC,CAAC;SACJ;aAAM;YACL,KAAK,CAAC,KAAK,CAAC,oBAAoB,CAAC,CAAC;SACnC;QAED,IAAI,yBAAyB,EAAE;YAC7B,IAAI,CAAC,eAAe,GAAG,EAAE,CAAC,CAAC,mEAAmE;SAC/F;QAED,OAAO,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;IAC7B,CAAC;IAED;;OAEG;IACI,IAAI;QACT,KAAK,CAAC,IAAI,EAAE,CAAC;QACb,IAAI,CAAC,cAAc,EAAE,CAAC;IACxB,CAAC;IAED;;;;OAIG;IACI,EAAE,CAAC,IAAY,EAAE,QAAiB;QACvC,wEAAwE;QACxE,OAAO,KAAK,CAAC,EAAE,CAAC,IAAI,EAAE,QAAQ,CAAC,CAAC;IAClC,CAAC;IAED;;;;OAIG;IACI,IAAI,CAAC,IAAY,EAAE,GAAG,IAAe;QAC1C,0EAA0E;QAC1E,KAAK,CAAC,IAAI,CAAC,IAAI,EAAE,GAAG,IAAI,CAAC,CAAC;IAC5B,CAAC;IAED;;OAEG;IACK,cAAc;;QACpB,MAAM,CAAC,aAAa,iCACf,IAAI,CAAC,QAAQ,KAChB,iBAAiB,EAAE,oBAAoB,EAAE,EACzC,YAAY,EAAE,CAAA,MAAA,YAAY,EAAE,0CAAE,GAAG,KAAI,EAAE,EACvC,mBAAmB,EACjB,IAAI,CAAC,aAAa,CAAC,8BAA8B,CAAC;gBAClD,SAAS,IAAI,IAAI,CAAC,aAAa,CAAC,8BAA8B,CAAC;gBAC7D,CAAC,CAAE,IAAI,CAAC,aAAa,CAAC,8BAA8B,CAAgD,CAAC,OAAO;gBAC5G,CAAC,CAAC,SAAS,IACf;aACC,IAAI,CACH,CAAC,MAAe,EAAE,EAAE;YAClB,OAAO,MAAM,CAAC;QAChB,CAAC,EACD,GAAG,EAAE;YACH,IAAI,CAAC,wBAAwB,EAAE,CAAC;YAChC,OAAO,KAAK,CAAC;QACf,CAAC,CACF;aACA,IAAI,CAAC,CAAC,iBAA0B,EAAE,EAAE;;YACnC,MAAA,MAAA,IAAI,CAAC,QAAQ,EAAC,OAAO,mDAAG,EAAE,iBAAiB,EAAE,CAAC,CAAC;YAC/C,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QACzB,CAAC,CAAC;aACD,IAAI,CAAC,SAAS,EAAE,KAAK,CAAC,EAAE;YACvB,KAAK,CAAC,KAAK,CAAC,uCAAuC,EAAE,KAAK,CAAC,CAAC;QAC9D,CAAC,CAAC,CAAC;IACP,CAAC;IAED;;OAEG;IACK,wBAAwB;QAC9B,IAAI,OAAO,IAAI,IAAI,CAAC,QAAQ,CAAC,kBAAkB,EAAE;YAC/C,KAAK,CAAC,KAAK,CACT,QAAQ,EACR,6NAA6N,CAC9N,CAAC;SACH;IACH,CAAC;IAED;;OAEG;IACK,qBAAqB,CAAC,QAAmB,EAAE,QAA8B;QAC/E,IAAI,QAAQ,CAAC,MAAM,GAAG,CAAC,EAAE;YACvB,MAAM,gBAAgB,GAAqB;gBACzC,EAAE,IAAI,EAAE,eAAe,EAAE;gBACzB;oBACE,SAAS,EAAE,sBAAsB,EAAE;oBACnC,gBAAgB,EAAE,QAAQ;iBAC3B;aACF,CAAC;YAEF,QAAQ,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;SACxC;IACH,CAAC;CACF","sourcesContent":["import { eventFromException, eventFromMessage } from '@sentry/browser';\nimport type {\n  ClientReportEnvelope,\n  ClientReportItem,\n  Envelope,\n  Event,\n  EventHint,\n  Outcome,\n  SeverityLevel,\n  TransportMakeRequestResponse,\n  UserFeedback,\n} from '@sentry/core';\nimport {\n  _INTERNAL_flushLogsBuffer,\n  addAutoIpAddressToSession,\n  Client,\n  dateTimestampInSeconds,\n  debug,\n  SentryError,\n} from '@sentry/core';\nimport { Alert } from 'react-native';\nimport { getDevServer } from './integrations/debugsymbolicatorutils';\nimport { defaultSdkInfo } from './integrations/sdkinfo';\nimport { getDefaultSidecarUrl } from './integrations/spotlight';\nimport type { ReactNativeClientOptions } from './options';\nimport type { mobileReplayIntegration } from './replay/mobilereplay';\nimport { MOBILE_REPLAY_INTEGRATION_NAME } from './replay/mobilereplay';\nimport { createUserFeedbackEnvelope, items } from './utils/envelope';\nimport { ignoreRequireCycleLogs } from './utils/ignorerequirecyclelogs';\nimport { mergeOutcomes } from './utils/outcome';\nimport { ReactNativeLibraries } from './utils/rnlibraries';\nimport { NATIVE } from './wrapper';\n\nconst DEFAULT_FLUSH_INTERVAL = 5000;\n\n/**\n * The Sentry React Native SDK Client.\n *\n * @see ReactNativeClientOptions for documentation on configuration options.\n * @see SentryClient for usage documentation.\n */\nexport class ReactNativeClient extends Client<ReactNativeClientOptions> {\n  private _outcomesBuffer: Outcome[];\n  private _logFlushIdleTimeout: ReturnType<typeof setTimeout> | undefined;\n\n  /**\n   * Creates a new React Native SDK instance.\n   * @param options Configuration options for this SDK.\n   */\n  public constructor(options: ReactNativeClientOptions) {\n    ignoreRequireCycleLogs(ReactNativeLibraries.ReactNativeVersion?.version);\n    options._metadata = {\n      ...options._metadata,\n      sdk: {\n        ...(options._metadata?.sdk || defaultSdkInfo),\n        settings: {\n          // Only allow IP inferral by Relay if sendDefaultPii is true\n          infer_ip: options.sendDefaultPii ? 'auto' : 'never',\n          ...options._metadata?.sdk?.settings,\n        },\n      },\n    };\n\n    // We default this to true, as it is the safer scenario\n    options.parentSpanIsAlwaysRootSpan =\n      options.parentSpanIsAlwaysRootSpan === undefined ? true : options.parentSpanIsAlwaysRootSpan;\n\n    // enableLogs must be disabled before calling super() to avoid logs being captured.\n    // This makes a copy of the user defined value, so we can restore it later for the native usaege.\n    const originalEnableLogs = options.enableLogs;\n    if (options.enableLogs && options.logsOrigin === 'native') {\n      debug.log('disabling Sentry logs on JavaScript due to rule set by logsOrigin');\n      options.enableLogs = false;\n    }\n\n    super(options);\n\n    this._outcomesBuffer = [];\n\n    if (options.sendDefaultPii === true) {\n      this.on('beforeSendSession', addAutoIpAddressToSession);\n    }\n\n    if (options.enableLogs) {\n      this.on('flush', () => {\n        _INTERNAL_flushLogsBuffer(this);\n      });\n\n      this.on('afterCaptureLog', () => {\n        if (this._logFlushIdleTimeout) {\n          clearTimeout(this._logFlushIdleTimeout);\n        }\n\n        this._logFlushIdleTimeout = setTimeout(() => {\n          _INTERNAL_flushLogsBuffer(this);\n        }, DEFAULT_FLUSH_INTERVAL);\n      });\n    }\n\n    // Restore original settings for enabling Native options.\n    options.enableLogs = originalEnableLogs;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public eventFromException(exception: unknown, hint: EventHint = {}): PromiseLike<Event> {\n    return eventFromException(this._options.stackParser, exception, hint, this._options.attachStacktrace);\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public eventFromMessage(message: string, level?: SeverityLevel, hint?: EventHint): PromiseLike<Event> {\n    return eventFromMessage(this._options.stackParser, message, level, hint, this._options.attachStacktrace);\n  }\n\n  /**\n   * If native client is available it will trigger a native crash.\n   * Use this only for testing purposes.\n   */\n  public nativeCrash(): void {\n    NATIVE.nativeCrash();\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public close(): PromiseLike<boolean> {\n    // As super.close() flushes queued events, we wait for that to finish before closing the native SDK.\n    return super.close().then((result: boolean) => {\n      return NATIVE.closeNativeSdk().then(() => result);\n    });\n  }\n\n  /**\n   * Sends user feedback to Sentry.\n   * @deprecated Use `Sentry.captureFeedback` instead.\n   */\n  public captureUserFeedback(feedback: UserFeedback): void {\n    const envelope = createUserFeedbackEnvelope(feedback, {\n      metadata: this._options._metadata,\n      dsn: this.getDsn(),\n      tunnel: undefined,\n    });\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\n    this.sendEnvelope(envelope);\n  }\n\n  /**\n   * @inheritdoc\n   */\n  public sendEnvelope(envelope: Envelope): PromiseLike<TransportMakeRequestResponse> {\n    const outcomes = this._clearOutcomes();\n    this._outcomesBuffer = mergeOutcomes(this._outcomesBuffer, outcomes);\n\n    if (this._options.sendClientReports) {\n      this._attachClientReportTo(this._outcomesBuffer, envelope as ClientReportEnvelope);\n    }\n\n    let shouldClearOutcomesBuffer = true;\n    if (this._isEnabled() && this._transport && this._dsn) {\n      this.emit('beforeEnvelope', envelope);\n\n      this._transport.send(envelope).then(null, reason => {\n        if (reason instanceof SentryError) {\n          // SentryError is thrown by SyncPromise\n          shouldClearOutcomesBuffer = false;\n          // If this is called asynchronously we want the _outcomesBuffer to be cleared\n          debug.error('SentryError while sending event, keeping outcomes buffer:', reason);\n        } else {\n          debug.error('Error while sending event:', reason);\n        }\n      });\n    } else {\n      debug.error('Transport disabled');\n    }\n\n    if (shouldClearOutcomesBuffer) {\n      this._outcomesBuffer = []; // if send fails synchronously the _outcomesBuffer will stay intact\n    }\n\n    return Promise.resolve({});\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public init(): void {\n    super.init();\n    this._initNativeSdk();\n  }\n\n  /**\n   * Register a hook on this client.\n   *\n   * (Generic method signature to allow for custom React Native Client events.)\n   */\n  public on(hook: string, callback: unknown): () => void {\n    // @ts-expect-error on from the base class doesn't support generic types\n    return super.on(hook, callback);\n  }\n\n  /**\n   * Emit a hook that was previously registered via `on()`.\n   *\n   * (Generic method signature to allow for custom React Native Client events.)\n   */\n  public emit(hook: string, ...rest: unknown[]): void {\n    // @ts-expect-error emit from the base class doesn't support generic types\n    super.emit(hook, ...rest);\n  }\n\n  /**\n   * Starts native client with dsn and options\n   */\n  private _initNativeSdk(): void {\n    NATIVE.initNativeSdk({\n      ...this._options,\n      defaultSidecarUrl: getDefaultSidecarUrl(),\n      devServerUrl: getDevServer()?.url || '',\n      mobileReplayOptions:\n        this._integrations[MOBILE_REPLAY_INTEGRATION_NAME] &&\n        'options' in this._integrations[MOBILE_REPLAY_INTEGRATION_NAME]\n          ? (this._integrations[MOBILE_REPLAY_INTEGRATION_NAME] as ReturnType<typeof mobileReplayIntegration>).options\n          : undefined,\n    })\n      .then(\n        (result: boolean) => {\n          return result;\n        },\n        () => {\n          this._showCannotConnectDialog();\n          return false;\n        },\n      )\n      .then((didCallNativeInit: boolean) => {\n        this._options.onReady?.({ didCallNativeInit });\n        this.emit('afterInit');\n      })\n      .then(undefined, error => {\n        debug.error('The OnReady callback threw an error: ', error);\n      });\n  }\n\n  /**\n   * If the user is in development mode, and the native nagger is enabled then it will show an alert.\n   */\n  private _showCannotConnectDialog(): void {\n    if (__DEV__ && this._options.enableNativeNagger) {\n      Alert.alert(\n        'Sentry',\n        'Warning, could not connect to Sentry native SDK.\\nIf you do not want to use the native component please pass `enableNative: false` in the options.\\nVisit: https://docs.sentry.io/platforms/react-native/ for more details.',\n      );\n    }\n  }\n\n  /**\n   * Attaches a client report from outcomes to the envelope.\n   */\n  private _attachClientReportTo(outcomes: Outcome[], envelope: ClientReportEnvelope): void {\n    if (outcomes.length > 0) {\n      const clientReportItem: ClientReportItem = [\n        { type: 'client_report' },\n        {\n          timestamp: dateTimestampInSeconds(),\n          discarded_events: outcomes,\n        },\n      ];\n\n      envelope[items].push(clientReportItem);\n    }\n  }\n}\n"]}