// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String          @id @default(cuid())
  email            String          @unique
  phoneNumber      String?         @unique
  passwordHash     String?
  username         String          @unique
  displayName      String?
  bio              String?
  avatarUrl        String?
  city             String?

  // OAuth providers
  appleId          String?         @unique
  googleId         String?         @unique
  spotifyId        String?         @unique
  spotifyUsername  String?
  spotifyToken     String?
  spotifyRefresh   String?
  spotifyTokenExpiry DateTime?

  // Legacy / optional
  appleMusicId     String?

  // Password reset
  resetToken       String?
  resetTokenExpiry DateTime?

  // Email verification (optional MVP)
  emailVerified    Boolean         @default(false)
  verifyToken      String?

  privacySetting   PrivacySetting  @default(PUBLIC)

  // Settings (mobile)
  activityVisibility PrivacySetting @default(FRIENDS)
  showInSuggestions  Boolean        @default(true)
  allowTagging       Boolean        @default(true)
  homeCity           String?
  distanceUnit       String         @default("miles") // miles, km
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  logs             UserLog[]
  tickets          UserTicket[]
  photos           LogPhoto[]
  showMedia        ShowMedia[]
  following        Follow[]        @relation("Following")
  followers        Follow[]        @relation("Followers")
  artistFollows    UserArtistFollow[]
  interestedEvents UserInterested[]
  badges           UserBadge[]
  venueRatings     VenueRating[]
  venueTips        VenueTip[]
  tipUpvotes       TipUpvote[]
  seatViews        SeatView[]
  comments         Comment[]
  logTagsGiven     LogTag[]        @relation("LogTagger")
  logTagsReceived  LogTag[]        @relation("LogTagged")
  wasThere         WasThere[]
  presaleAlerts    PresaleAlert[]
  fanclubs         UserFanclub[]
  eventTracking    UserEventTracking[]
}

enum PrivacySetting {
  PUBLIC
  FRIENDS
  PRIVATE
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower    User     @relation("Following", fields: [followerId], references: [id])
  following   User     @relation("Followers", fields: [followingId], references: [id])

  @@unique([followerId, followingId])
}

model Artist {
  id        String   @id @default(cuid())
  name      String
  spotifyId String?  @unique
  imageUrl  String?
  genres    String[]
  bio       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events    Event[]
  followers UserArtistFollow[]
}

model Venue {
  id        String   @id @default(cuid())
  name      String
  city      String
  state     String?
  country   String
  address   String?
  lat       Float?
  lng       Float?
  capacity  Int?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events    Event[]
  ratings   VenueRating[]
  tips      VenueTip[]
  seatViews SeatView[]
}

model Event {
  id         String   @id @default(cuid())
  name       String
  date       DateTime
  imageUrl   String?
  source     String?
  externalId String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  artistId   String
  artist     Artist   @relation(fields: [artistId], references: [id])
  venueId    String
  venue      Venue    @relation(fields: [venueId], references: [id])

  logs       UserLog[]
  tickets    UserTicket[]
  interested UserInterested[]
  tracking   UserEventTracking[]
  seatViews  SeatView[]
  userBadges UserBadge[]
  showMedia  ShowMedia[]

  @@unique([artistId, venueId, date])
}

model UserLog {
  id         String         @id @default(cuid())
  section    String?
  row        String?
  seat       String?
  rating     Float?
  note       String?
  visibility PrivacySetting @default(PUBLIC)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  userId     String
  user       User           @relation(fields: [userId], references: [id])
  eventId    String
  event      Event          @relation(fields: [eventId], references: [id])

  photos     LogPhoto[]
  comments   Comment[]
  tags       LogTag[]
  wasThere   WasThere[]

  @@unique([userId, eventId])
}

model LogTag {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())

  logId        String
  log          UserLog  @relation(fields: [logId], references: [id], onDelete: Cascade)

  userId       String
  user         User     @relation("LogTagger", fields: [userId], references: [id], onDelete: Cascade)

  taggedUserId String
  taggedUser   User     @relation("LogTagged", fields: [taggedUserId], references: [id], onDelete: Cascade)

  @@unique([logId, taggedUserId])
  @@index([taggedUserId])
}

model LogPhoto {
  id         String         @id @default(cuid())
  photoUrl   String
  visibility PrivacySetting @default(PUBLIC)
  isFlagged  Boolean        @default(false)
  createdAt  DateTime       @default(now())

  logId      String
  log        UserLog        @relation(fields: [logId], references: [id])
  userId     String
  user       User           @relation(fields: [userId], references: [id])
}

model ShowMedia {
  id          String   @id @default(cuid())
  uri         String
  type        String   // "photo" | "video"
  uploadedAt  DateTime @default(now())
  storagePath String?

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventId])
  @@index([uploadedAt])
}

// ============================================
// PRESALE INTEL (from your ERP)
// ============================================

model Presale {
  id             String   @id @default(cuid())

  // Event info
  artistName     String
  tourName       String?
  venueName      String
  venueCity      String
  venueState     String?
  eventDate      DateTime

  // Presale details
  presaleType    String   // "Verified Fan", "Amex", "Fan Club", etc.
  presaleStart   DateTime
  presaleEnd     DateTime?
  onsaleStart    DateTime?

  // Access
  code           String?
  signupUrl      String?
  signupDeadline DateTime?
  ticketUrl      String?

  // Metadata
  source         String   // "ERP", "Manual", "Community"
  notes          String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  alerts         PresaleAlert[]

  @@unique([artistName, venueName, eventDate, presaleType])
  @@index([artistName])
  @@index([presaleStart])
  @@index([eventDate])
}

model PresaleAlert {
  id          String   @id @default(cuid())
  userId      String
  presaleId   String

  notifyStart Boolean  @default(true)
  notifyCode  Boolean  @default(true)

  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  presale     Presale  @relation(fields: [presaleId], references: [id], onDelete: Cascade)

  @@unique([userId, presaleId])
  @@index([userId])
  @@index([presaleId])
}

model UserTicket {
  id                 String       @id @default(cuid())

  section            String?
  row                String?
  seat               String?
  isGeneralAdmission Boolean      @default(false)

  barcode            String?
  barcodeFormat      String       @default("UNKNOWN")
  barcodeImageUrl    String?

  status             TicketStatus @default(KEEPING)
  source             TicketSource @default(MANUAL)

  // Phase 2 prep
  askingPrice        Float?

  purchasePrice      Float?
  purchaseDate       DateTime?
  confirmationNumber String?
  notes              String?

  sourceEmail        String?
  rawEmailId         String?
  pdfUrl             String?

  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  userId             String
  user               User         @relation(fields: [userId], references: [id])
  eventId            String
  event              Event        @relation(fields: [eventId], references: [id])

  @@unique([userId, eventId, barcode])
  @@index([userId])
  @@index([eventId])
  @@index([status])
}

enum TicketStatus {
  KEEPING
  SELLING
  SOLD
  TRANSFERRED
}

enum TicketSource {
  EMAIL
  MANUAL
  SCAN
  TRANSFER
}

model UserInterested {
  id           String   @id @default(cuid())
  notifyOnSale Boolean  @default(true)
  createdAt    DateTime @default(now())

  userId       String
  user         User     @relation(fields: [userId], references: [id])
  eventId      String
  event        Event    @relation(fields: [eventId], references: [id])

  @@unique([userId, eventId])
}

model UserArtistFollow {
  id        String   @id @default(cuid())
  notify    Boolean  @default(true)
  tier      String   @default("following") // "top-tier", "following", "casual"
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id])
  artistId  String
  artist    Artist   @relation(fields: [artistId], references: [id])

  @@unique([userId, artistId])
  @@index([userId])
  @@index([tier])
}

// NEW: Fanclub membership tracking (user self-reported)
model UserFanclub {
  id          String   @id @default(cuid())

  artistId    String
  artistName  String   // Denormalized for display
  fanclubName String   // "Taylor Nation", "BeyHive", etc.

  isMember    Boolean  @default(false)
  memberSince DateTime?
  renewalDate DateTime?
  cost        Float?   // Annual cost if known
  signupUrl   String?  // Link to official signup

  notes       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, artistId])
  @@index([userId])
  @@index([renewalDate])
}

// NEW: User event tracking status (beyond just "interested")
model UserEventTracking {
  id        String   @id @default(cuid())

  status    String   // "interested", "watching-secondary", "presale-alert", "bought"
  maxPrice  Float?   // For secondary market alerts
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([userId])
  @@index([status])
}

model Comment {
  id        String   @id @default(cuid())
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id])
  logId     String
  log       UserLog  @relation(fields: [logId], references: [id])
}

model WasThere {
  id     String @id @default(cuid())
  userId String
  logId  String

  user User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  log  UserLog @relation(fields: [logId], references: [id], onDelete: Cascade)

  @@unique([userId, logId])
}

model Badge {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String   @unique
  description String
  category    String
  rarity      String
  icon        String
  points      Int      @default(0)
  iconUrl     String?
  criteria    Json
  createdAt   DateTime @default(now())

  users       UserBadge[]
}

model UserBadge {
  id      String   @id @default(cuid())
  earnedAt DateTime @default(now())

  userId  String
  user    User     @relation(fields: [userId], references: [id])
  badgeId String
  badge   Badge    @relation(fields: [badgeId], references: [id])
  eventId String?
  event   Event?   @relation(fields: [eventId], references: [id], onDelete: SetNull)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([eventId])
}

model VenueRating {
  id         String   @id @default(cuid())
  sound      Int?
  sightlines Int?
  drinks     Int?
  staff      Int?
  access     Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  userId     String
  user       User     @relation(fields: [userId], references: [id])
  venueId    String
  venue      Venue    @relation(fields: [venueId], references: [id])

  @@unique([userId, venueId])
}

model VenueTip {
  id        String   @id @default(cuid())
  text      String
  category  String   @default("general")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id])
  venueId   String
  venue     Venue    @relation(fields: [venueId], references: [id])

  upvotes   TipUpvote[]

  @@index([venueId])
}

model TipUpvote {
  id     String @id @default(cuid())
  userId String
  tipId  String

  user User     @relation(fields: [userId], references: [id])
  tip  VenueTip @relation(fields: [tipId], references: [id])

  @@unique([userId, tipId])
}

model SeatView {
  id        String   @id @default(cuid())
  section   String
  row       String?
  photoUrl  String
  thumbnailUrl String?
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id])
  venueId   String
  venue     Venue    @relation(fields: [venueId], references: [id])
  eventId   String?
  event     Event?   @relation(fields: [eventId], references: [id])
}



